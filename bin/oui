#! /usr/bin/env python

"""Search text

Usage: %(prog)s searches [files]

Searches ("fred" is a regular expression):

    /fred        show only lines with fred
    =fred        remove all lines with fred

"""

import doctest
import os
import re
import sys
from functools import partial

from pysyte import __version__
from pysyte.cli.functions import parser
from pysyte.cli.main import run


def add_args(parser_):
    p = parser(parser_)
    p.positional('searches', help='What to search for')
    p.positional('files', help='files to search (if none: search stdin)')
    p.lines()
    p.version()
    return p


def parse_sought(string, separator):
    regexp = re.compile(f'''
        (?P<separator>[{separator}])
        (?P<sought>[^{separator}]+)
    ''', re.VERBOSE)
    match = regexp.match(string)
    if not match:
        return {}
    result = match.groupdict()
    result['separator'] = separator
    return result


def post_parse(args):
    matchers = (partial(parse_sought, separator=s) for s in '/=')
    matches = [m(c) for m in matchers for c in args.searches]
    args.actions = [m for m in matches if m]
    return args

def main(args):
    for action in args.actions:
        sought = action.get('sought', '')
        separator = action.get('separator', '')
        if separator == '/':
            print(f'Find {sought}')
        else:
            print(f'Remove {sought}')


run(main, add_args, post_parse)
